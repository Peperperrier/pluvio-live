<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <title>Historique des Pr√©cipitations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;  /* R√©duit de 30px √† 20px pour mobile */
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;  /* R√©duit de 30px √† 20px */
            font-size: clamp(1.5em, 5vw, 2.5em);  /* Taille responsive */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr;  /* Une colonne sur mobile */
            gap: 15px;  /* R√©duit de 20px √† 15px */
            margin-bottom: 30px;
            padding: 15px;  /* R√©duit de 20px √† 15px */
            background: #f8f9fa;
            border-radius: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: auto;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: 1fr;  /* Une colonne sur mobile */
            gap: 15px;  /* R√©duit de 20px √† 15px */
            margin-bottom: 30px;
        }

        @media (min-width: 600px) {
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .summary-card {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .value {
            font-size: 1.5em;  /* R√©duit de 2em √† 1.5em */
            font-weight: 700;
        }

        .chart-container {
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow-x: auto;
            min-height: 300px; /* Ajout d'une hauteur minimale */
            position: relative; /* Important pour Chart.js */
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
            min-height: 250px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            font-size: 0.9em;  /* Texte l√©g√®rement plus petit sur mobile */
            min-width: 600px;  /* Pour assurer la lisibilit√© des donn√©es */
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px;  /* R√©duit de 12-15px √† 8px */
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 8px;  /* R√©duit de 12-15px √† 8px */
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }

        .station-color-icussa12 { color: #667eea; }
        .station-color-icussa10 { color: #f97316; }
        .station-color-icussa13 { color: #10b981; }

        @media (max-width: 480px) {
            body {
                padding: 10px;  /* R√©duit de 20px √† 10px */
            }

            .summary-card {
                padding: 15px;  /* R√©duit de 20px √† 15px */
            }

            button {
                width: 100%;  /* Bouton pleine largeur sur mobile */
                padding: 10px 20px;  /* R√©duit de 12px 30px √† 10px 20px */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Historique des Pr√©cipitations</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="viewType">Type de vue</label>
                <select id="viewType">
                    <option value="day">Jour (heure par heure)</option>
                    <option value="last30">30 derniers jours</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="dateInput">Date de r√©f√©rence</label>
                <input type="date" id="dateInput">
            </div>
            
            <div class="control-group">
                <button onclick="fetchData()">üîç Charger les donn√©es</button>
            </div>
        </div>
        
        <div id="results" class="results"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // ‚ö†Ô∏è INS√âREZ VOTRE CL√â API ICI
        const API_KEY = 'e1f10a1e78da46f5b10a1e78da96f525';
        
        const STATIONS = [
            { id: 'ICUSSA12', color: 'rgba(102, 126, 234, 1)', bgColor: 'rgba(102, 126, 234, 0.2)' },
            { id: 'ICUSSA10', color: 'rgba(249, 115, 22, 1)', bgColor: 'rgba(249, 115, 22, 0.2)' },
            { id: 'ICUSSA13', color: 'rgba(16, 185, 129, 1)', bgColor: 'rgba(16, 185, 129, 0.2)' }
        ];
        
        let chartInstance = null;

        // Initialiser la date d'aujourd'hui
        document.getElementById('dateInput').valueAsDate = new Date();

        function getDateRange(viewType, referenceDate) {
            const dates = [];
            const ref = new Date(referenceDate);
            
            if (viewType === 'day') {
                dates.push(formatDate(ref));
            } else if (viewType === 'last30') {
                for (let i = 29; i >= 0; i--) {
                    const d = new Date(ref);
                    d.setDate(d.getDate() - i);
                    dates.push(formatDate(d));
                }
            }
            
            return dates;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function formatDisplayDate(dateStr) {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            return `${day}/${month}/${year}`;
        }

        async function fetchStationData(stationId, date, apiKey) {
            const url = `https://api.weather.com/v2/pws/history/all?stationId=${stationId}&format=json&units=m&date=${date}&numericPrecision=decimal&apiKey=${apiKey}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Erreur pour ${stationId} le ${date}:`, error);
                return null;
            }
        }

        // Extraction de precipRate pour affichage heure par heure
        function extractPrecipRateByHour(data) {
            if (!data || !data.observations) return {};
            
            const hourlyData = {};
            
            data.observations.forEach(obs => {
                if (obs.obsTimeLocal && obs.metric && obs.metric.precipRate !== undefined && obs.metric.precipRate !== null) {
                    const hour = new Date(obs.obsTimeLocal).getHours();
                    const rate = parseFloat(obs.metric.precipRate);
                    
                    // Prendre la valeur maximale de precipRate pour chaque heure
                    if (!hourlyData[hour] || rate > hourlyData[hour]) {
                        hourlyData[hour] = rate;
                    }
                }
            });
            
            return hourlyData;
        }

        // Extraction de precipTotal (cumul journalier) pour les totaux
        function extractPrecipTotal(data) {
            if (!data || !data.observations || data.observations.length === 0) return 0;
            
            // precipTotal est d√©j√† cumulatif, on prend la valeur maximale (derni√®re observation)
            let maxPrecip = 0;
            data.observations.forEach(obs => {
                if (obs.metric && obs.metric.precipTotal !== undefined && obs.metric.precipTotal !== null) {
                    const precip = parseFloat(obs.metric.precipTotal);
                    if (precip > maxPrecip) {
                        maxPrecip = precip;
                    }
                }
            });
            
            return maxPrecip;
        }

        async function fetchData() {
            const viewType = document.getElementById('viewType').value;
            const dateInput = document.getElementById('dateInput').value;
            const resultsDiv = document.getElementById('results');
            
            if (!API_KEY || API_KEY === 'VOTRE_CLE_API_ICI') {
                resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è Veuillez configurer votre cl√© API dans le code (variable API_KEY)</div>';
                return;
            }
            
            if (!dateInput) {
                resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è Veuillez s√©lectionner une date</div>';
                return;
            }
            
            const dates = getDateRange(viewType, dateInput);
            
            resultsDiv.innerHTML = `<div class="loading">‚è≥ Chargement des donn√©es pour ${dates.length} jour${dates.length > 1 ? 's' : ''}...</div>`;
            
            const stationsData = {};
            
            // Initialiser les donn√©es pour chaque station
            for (const station of STATIONS) {
                stationsData[station.id] = {
                    hourlyRates: viewType === 'day' ? {} : null,  // precipRate par heure
                    dailyTotals: viewType === 'last30' ? [] : null,  // precipTotal par jour
                    total: 0  // Somme des precipTotal
                };
            }
            
            // R√©cup√©rer les donn√©es pour chaque date et station
            let processedDates = 0;
            for (const date of dates) {
                processedDates++;
                if (processedDates % 5 === 0 || processedDates === dates.length) {
                    resultsDiv.innerHTML = `<div class="loading">‚è≥ Chargement... ${processedDates}/${dates.length} jours</div>`;
                }
                
                for (const station of STATIONS) {
                    const data = await fetchStationData(station.id, date, API_KEY);
                    
                    if (!data) continue;
                    
                    // Toujours extraire precipTotal pour le cumul
                    const dailyTotal = extractPrecipTotal(data);
                    stationsData[station.id].total += dailyTotal;
                    
                    if (viewType === 'day') {
                        // Pour la vue jour : extraire precipRate par heure
                        const hourlyRates = extractPrecipRateByHour(data);
                        for (const [hour, rate] of Object.entries(hourlyRates)) {
                            if (!stationsData[station.id].hourlyRates[hour]) {
                                stationsData[station.id].hourlyRates[hour] = rate;
                            } else {
                                // Prendre le max si plusieurs valeurs
                                stationsData[station.id].hourlyRates[hour] = Math.max(
                                    stationsData[station.id].hourlyRates[hour],
                                    rate
                                );
                            }
                        }
                    } else {
                        // Pour la vue 30 jours : stocker precipTotal par jour
                        stationsData[station.id].dailyTotals.push({ 
                            date, 
                            total: dailyTotal 
                        });
                    }
                }
            }
            
            displayResults(stationsData, viewType, dateInput);
        }

        function displayResults(stationsData, viewType, dateInput) {
            const resultsDiv = document.getElementById('results');
            let html = '';
            
            // Cartes de r√©sum√© (toujours precipTotal)
            html += '<div class="summary-cards">';
            for (const station of STATIONS) {
                html += `
                    <div class="summary-card">
                        <h3>üìç ${station.id}</h3>
                        <div class="value">${stationsData[station.id].total.toFixed(2)} mm</div>
                    </div>
                `;
            }
            html += '</div>';
            
            // Graphique
            html += `
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            `;
            
            // Tableau de donn√©es
            html += '<div class="chart-container">';
            html += '<table class="data-table"><thead><tr>';
            
            if (viewType === 'day') {
                html += '<th>Heure</th>';
                for (const station of STATIONS) {
                    html += `<th class="station-color-${station.id.toLowerCase()}">${station.id} (mm/h)</th>`;
                }
                html += '</tr></thead><tbody>';
                
                for (let hour = 0; hour < 24; hour++) {
                    let hasData = false;
                    let rowData = '';
                    
                    for (const station of STATIONS) {
                        const rate = stationsData[station.id].hourlyRates[hour] || 0;
                        if (rate > 0) hasData = true;
                        rowData += `<td>${rate.toFixed(2)}</td>`;
                    }
                    
                    if (hasData) {
                        html += `<tr><td>${hour}h</td>${rowData}</tr>`;
                    }
                }
            } else {
                html += '<th>Date</th>';
                for (const station of STATIONS) {
                    html += `<th class="station-color-${station.id.toLowerCase()}">${station.id} (mm)</th>`;
                }
                html += '</tr></thead><tbody>';
                
                const dates = stationsData[STATIONS[0].id].dailyTotals.map(d => d.date);
                
                dates.forEach(date => {
                    let hasData = false;
                    let rowData = '';
                    
                    for (const station of STATIONS) {
                        const entry = stationsData[station.id].dailyTotals.find(d => d.date === date);
                        const total = entry ? entry.total : 0;
                        if (total > 0) hasData = true;
                        rowData += `<td>${total.toFixed(2)}</td>`;
                    }
                    
                    if (hasData) {
                        html += `<tr><td>${formatDisplayDate(date)}</td>${rowData}</tr>`;
                    }
                });
            }
            
            html += '</tbody></table></div>';
            
            resultsDiv.innerHTML = html;
            
            // Cr√©er le graphique
            createChart(stationsData, viewType);
        }

        function createChart(stationsData, viewType) {
            const ctx = document.getElementById('mainChart');
            if (!ctx) return;
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            let labels = [];
            const datasets = [];
            
            if (viewType === 'day') {
                // Labels: heures de 0 √† 23
                labels = Array.from({length: 24}, (_, i) => `${i}h`);
                
                for (const station of STATIONS) {
                    const data = Array.from({length: 24}, (_, hour) => 
                        stationsData[station.id].hourlyRates[hour] || 0
                    );
                    
                    datasets.push({
                        label: station.id,
                        data: data,
                        backgroundColor: station.bgColor,
                        borderColor: station.color,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    });
                }
            } else {
                // Labels: dates
                labels = stationsData[STATIONS[0].id].dailyTotals.map(d => formatDisplayDate(d.date));
                
                for (const station of STATIONS) {
                    const data = stationsData[station.id].dailyTotals.map(d => d.total);
                    
                    datasets.push({
                        label: station.id,
                        data: data,
                        backgroundColor: station.bgColor,
                        borderColor: station.color,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    });
                }
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Chang√© en false pour permettre une hauteur dynamique
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12, // R√©duction de la taille des l√©gendes sur mobile
                                padding: 10
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            padding: 10,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            caretSize: 6,
                            caretPadding: 10
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: true
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: viewType === 'day' ? 'Heures' : 'Dates',
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                padding: { top: 10, left: 10, right: 10, bottom: 0 }
                            },
                            ticks: {
                                color: '#666',
                                padding: 10
                            },
                            grid: {
                                color: '#e0e0e0',
                                lineWidth: 1
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Pr√©cipitations (mm)',
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                padding: { top: 10, left: 10, right: 10, bottom: 0 }
                            },
                            ticks: {
                                color: '#666',
                                padding: 10,
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            },
                            grid: {
                                color: '#e0e0e0',
                                lineWidth: 1
                            }
                        }
                    }
                }
            });
        }

        // Chargement initial des donn√©es
        fetchData();
    </script>
</body>
</html>
